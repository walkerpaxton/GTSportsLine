{% extends 'base.html' %}

{% block title %}Upcoming Odds{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Upcoming Game Odds</h1>

    {% if games %}
        {% for game in games %}
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h4>
                        <a href="{% url 'odds:game_detail' game.id %}" style="text-decoration: none; color: #028af9;">
                            {{ game.away_team }}
                            <span class="text-muted">@</span>
                            {{ game.home_team }}
                        </a>
                    </h4>
                    <h6 class="card-subtitle mb-2 text-muted">
                        {{ game.game_time|date:"D, M j, Y - g:i A" }}
                    </h6>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-bordered">
                        <thead class="thead-dark">
                            <tr>
                                <th>Team</th>
                                <th>Moneyline</th>
                                <th>Spread</th>
                                <th>Spread Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>{{ game.away_team }}</strong></td>
                                <td>{{ game.away_team_moneyline }}</td>
                                <td>{{ game.away_team_spread }}</td>
                                <td>{{ game.away_team_spread_price }}</td>
                            </tr>
                            <tr>
                                <td><strong>{{ game.home_team }}</strong></td>
                                <td>{{ game.home_team_moneyline }}</td>
                                <td>{{ game.home_team_spread }}</td>
                                <td>{{ game.home_team_spread_price }}</td>
                            </tr>
                        </tbody>
                    </table>

                    <h5 class="mt-3">Total (Over/Under)</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <strong>Over:</strong> {{ game.total_over }}
                            <span class="text-muted">({{ game.total_over_price }})</span>
                        </li>
                        <li class="list-group-item">
                            <strong>Under:</strong> {{ game.total_under }}
                            <span class="text-muted">({{ game.total_under_price }})</span>
                        </li>
                    </ul>

                </div>
                <div class="card-footer text-muted d-flex justify-content-between align-items-center" style="font-size: 0.9rem;">
                    <div>
                        Odds from: <strong>{{ game.bookmaker_name }}</strong>
                        | Last Updated: {{ game.last_updated|date:"M j, g:i A" }}
                    </div>
                    {% if user.is_authenticated %}
                    <button 
                        class="btn btn-sm {% if game.id in saved_game_ids %}btn-warning{% else %}btn-outline-warning{% endif %} save-bet-btn" 
                        data-game-id="{{ game.id }}"
                        style="{% if game.id in saved_game_ids %}background-color: #B3A369; border-color: #B3A369;{% endif %}">
                        <span class="save-text">{% if game.id in saved_game_ids %}Saved{% else %}Save{% endif %}</span>
                    </button>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info" role="alert">
            No upcoming games with odds are available at this time.
            <br>
            <small>Try running the fetch command: <code>python3 manage.py fetch_odds</code></small>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveButtons = document.querySelectorAll('.save-bet-btn');
    
    saveButtons.forEach(button => {
        button.addEventListener('click', function() {
            const gameId = this.getAttribute('data-game-id');
            const span = this.querySelector('.save-text');
            
            fetch(`/odds/${gameId}/save/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '{{ csrf_token }}'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.saved) {
                    this.classList.remove('btn-outline-warning');
                    this.classList.add('btn-warning');
                    this.style.backgroundColor = '#B3A369';
                    this.style.borderColor = '#B3A369';
                    span.textContent = 'Saved';
                } else {
                    this.classList.remove('btn-warning');
                    this.classList.add('btn-outline-warning');
                    this.style.backgroundColor = '';
                    this.style.borderColor = '';
                    span.textContent = 'Save';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Please log in to save bets.');
            });
        });
    });
});
</script>
{% endblock %}