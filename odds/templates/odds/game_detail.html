{% extends 'base.html' %}

{% block title %}{{ game.away_team }} @ {{ game.home_team }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <a href="{% url 'odds:odds_list' %}" class="btn btn-secondary">← Back to Odds</a>
        {% if user.is_authenticated %}
        <button 
            class="btn {% if is_saved %}btn-warning{% else %}btn-outline-warning{% endif %} save-bet-btn" 
            data-game-id="{{ game.id }}"
            style="{% if is_saved %}background-color: #B3A369; border-color: #B3A369;{% endif %}">
            <a href="{% url 'odds:game_detail' game.id %}" style="text-decoration: none; color: #000757;">
                {{ game.away_team }}
                <span class="text-muted">@</span>
                {{ game.home_team }}
            </a>
        </button>
        {% endif %}
    </div>

    <div class="card mb-4">
        <div class="card-header bg-light">
            <h4>
                {{ game.away_team }}
                <span class="text-muted">@</span>
                {{ game.home_team }}
            </h4>
            <h6 class="card-subtitle mb-2 text-muted">
                {{ game.game_time|date:"D, M j, Y - g:i A" }}
            </h6>
        </div>
        <div class="card-body">
            <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th>Team</th>
                        <th>Moneyline</th>
                        <th>Spread</th>
                        <th>Spread Price</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>{{ game.away_team }}</strong></td>
                        <td>{{ game.away_team_moneyline }}</td>
                        <td>{{ game.away_team_spread }}</td>
                        <td>{{ game.away_team_spread_price }}</td>
                    </tr>
                    <tr>
                        <td><strong>{{ game.home_team }}</strong></td>
                        <td>{{ game.home_team_moneyline }}</td>
                        <td>{{ game.home_team_spread }}</td>
                        <td>{{ game.home_team_spread_price }}</td>
                    </tr>
                </tbody>
            </table>

            <h5 class="mt-3">Total (Over/Under)</h5>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <strong>Over:</strong> {{ game.total_over }}
                    <span class="text-muted">({{ game.total_over_price }})</span>
                </li>
                <li class="list-group-item">
                    <strong>Under:</strong> {{ game.total_under }}
                    <span class="text-muted">({{ game.total_under_price }})</span>
                </li>
            </ul>
        </div>
        <div class="card-footer text-muted" style="font-size: 0.9rem;">
            Odds from: <strong>{{ game.bookmaker_name }}</strong>
            | Last Updated: {{ game.last_updated|date:"M j, g:i A" }}
        </div>
    </div>

    <!-- Comments Section -->
    <div class="card shadow p-3 mb-4 rounded">
        <div class="card-body">
            <h4 class="mb-3">Comments ({{ comments|length }})</h4>
            
            <!-- Comment Form -->
            {% if user.is_authenticated %}
            <form method="POST" class="mb-4">
                {% csrf_token %}
                <div class="mb-2">
                    {{ comment_form.content }}
                </div>
                <button type="submit" class="btn btn-primary">Post Comment</button>
            </form>
            {% else %}
            <p class="text-muted">Please <a href="{% url 'accounts.login' %}">login</a> to post a comment.</p>
            {% endif %}
            
            <hr>
            
            <!-- Comments List -->
            {% if comments %}
                {% for comment in comments %}
                <div class="mb-3 pb-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <strong>{{ comment.author.username }}</strong>
                            <small class="text-muted"> • {{ comment.created_at|date:"F d, Y g:i A" }}</small>
                            <p class="mt-2 mb-0">{{ comment.content }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No comments yet. Be the first to comment!</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveButton = document.querySelector('.save-bet-btn');
    
    if (saveButton) {
        saveButton.addEventListener('click', function() {
            const gameId = this.getAttribute('data-game-id');
            const span = this.querySelector('.save-text');
            
            fetch(`/odds/${gameId}/save/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '{{ csrf_token }}'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.saved) {
                    this.classList.remove('btn-outline-warning');
                    this.classList.add('btn-warning');
                    this.style.backgroundColor = '#B3A369';
                    this.style.borderColor = '#B3A369';
                    span.textContent = 'Saved';
                } else {
                    this.classList.remove('btn-warning');
                    this.classList.add('btn-outline-warning');
                    this.style.backgroundColor = '';
                    this.style.borderColor = '';
                    span.textContent = 'Save';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Please log in to save bets.');
            });
        });
    }
});
</script>
{% endblock %}

